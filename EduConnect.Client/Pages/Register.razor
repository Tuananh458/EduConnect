@page "/register"
@layout AuthLayout
@using EduConnect.Client.Services
@using EduConnect.Models.Auth
@inject AuthService AuthService
@inject IJSRuntime JSRuntime
@inject NavigationManager Nav

<div class="register-wrapper">
    <!-- Cột trái -->
    <div class="register-left">
        <div class="register-left-content">
            <img src="images/reg.gif" alt="Đăng ký" class="register-gif" />
            <h2 class="register-title">ĐĂNG KÝ NGAY</h2>
            <p class="register-subtitle">Học thử miễn phí cùng EduConnect</p>
        </div>
    </div>

    <!-- Cột phải -->
    <div class="register-right">
        <div class="register-form-container">
            <h3 class="form-title mb-4">Đăng ký tài khoản</h3>

            <EditForm Model="@registerModel" OnValidSubmit="@HandleRegister">
                <DataAnnotationsValidator />

                <!-- Họ và tên -->
                <div class="form-group mb-3">
                    <label class="form-label">Họ và tên</label>
                    <InputText @bind-Value="registerModel.FullName"
                               class="@GetInputClass(nameof(registerModel.FullName))"
                               placeholder="Nhập họ và tên"
                               disabled="@isLoading" />
                    @ValidationError(nameof(registerModel.FullName))
                </div>

                <!-- Tên đăng nhập -->
                <div class="form-group mb-3">
                    <label class="form-label">Tên đăng nhập</label>
                    <InputText @bind-Value="registerModel.Username"
                               class="@GetInputClass(nameof(registerModel.Username))"
                               placeholder="Nhập tên đăng nhập"
                               disabled="@isLoading" />
                    @ValidationError(nameof(registerModel.Username))
                </div>

                <!-- Email -->
                <div class="form-group mb-3">
                    <label class="form-label">Email</label>
                    <InputText @bind-Value="registerModel.Email"
                               type="email"
                               class="@GetInputClass(nameof(registerModel.Email))"
                               placeholder="Nhập email"
                               disabled="@isLoading" />
                    @ValidationError(nameof(registerModel.Email))
                </div>

                <!-- Mật khẩu -->
                <div class="form-group mb-3">
                    <label class="form-label">Mật khẩu</label>
                    <div class="password-box position-relative">
                        <InputText @bind-Value="registerModel.Password"
                                   type="@passwordType"
                                   class="@GetInputClass(nameof(registerModel.Password))"
                                   placeholder="Nhập mật khẩu (tối thiểu 6 ký tự)"
                                   disabled="@isLoading" />
                        <button type="button" class="eye-btn" @onclick="TogglePassword" disabled="@isLoading">
                            <i class="fa @(passwordType == "password" ? "fa-eye" : "fa-eye-slash")"></i>
                        </button>
                    </div>
                    @ValidationError(nameof(registerModel.Password))
                </div>

                <!-- Vai trò -->
                <div class="form-group mb-4">
                    <label class="form-label fw-semibold">Chọn vai trò</label>
                    <InputRadioGroup @bind-Value="registerModel.Role" class="role-group">
                        <div class="role-options">
                            <label class="role-option">
                                <InputRadio Value="@UserRole.HocSinh" id="roleStudent" />
                                <div class="role-card">
                                    <i class="fas fa-user-graduate"></i>
                                    <span>Học sinh</span>
                                </div>
                            </label>
                            <label class="role-option">
                                <InputRadio Value="@UserRole.GiaoVien" id="roleTeacher" />
                                <div class="role-card">
                                    <i class="fas fa-chalkboard-teacher"></i>
                                    <span>Giáo viên</span>
                                </div>
                            </label>
                            <label class="role-option">
                                <InputRadio Value="@UserRole.PhuHuynh" id="roleParent" />
                                <div class="role-card">
                                    <i class="fas fa-users"></i>
                                    <span>Phụ huynh</span>
                                </div>
                            </label>
                        </div>
                    </InputRadioGroup>
                    @ValidationError(nameof(registerModel.Role))
                </div>

                <!-- Nút đăng ký -->
                <button class="btn btn-primary btn-register w-100 mb-3" type="submit" disabled="@isLoading">
                    @if (isLoading)
                    {
                        <span><i class="fas fa-spinner fa-spin me-2"></i>Đang xử lý...</span>
                    }
                    else
                    {
                        <span>Đăng ký</span>
                    }
                </button>

                <div class="divider">
                    <span>Hoặc</span>
                </div>

                <!-- Đăng nhập Google -->
                <div class="google-signin-wrapper text-center mb-3">
                    <div id="googleSignInContainer"></div>
                </div>

                <div class="text-center">
                    <p class="login-link mb-0">
                        Đã có tài khoản?
                        <a href="/login" class="fw-semibold text-primary">Đăng nhập ngay</a>
                    </p>
                </div>
            </EditForm>
        </div>
    </div>
</div>

<style>
    .register-wrapper {
        display: flex;
        min-height: 100vh;
        background: #f8f9fa;
    }

    .register-left {
        flex: 1;
        
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem;
        color: white;
    }

    .register-left-content {
        text-align: center;
        max-width: 500px;
    }

    .register-gif {
        max-width: 100%;
        width: 350px;
        margin-bottom: 2rem;
        filter: drop-shadow(0 10px 30px rgba(0,0,0,0.2));
    }

    .register-title {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 1rem;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    }

    .register-subtitle {
        font-size: 1.2rem;
        opacity: 0.9;
    }

    .register-right {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem;
    }

    .register-form-container {
        width: 100%;
        max-width: 480px;
        background: white;
        padding: 2.5rem;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }

    .form-title {
        font-size: 1.75rem;
        font-weight: 600;
        color: #333;
        text-align: center;
    }

    .form-label {
        font-weight: 500;
        color: #555;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
    }

    .form-control {
        height: 45px;
        border-radius: 8px;
        border: 1px solid #ddd;
        padding: 0.75rem;
        font-size: 0.95rem;
        transition: all 0.3s;
    }

        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.15);
        }

        .form-control.is-invalid {
            border-color: #dc3545;
        }

    .password-box {
        position: relative;
    }

    .eye-btn {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        cursor: pointer;
        color: #6c757d;
        font-size: 1.1rem;
        padding: 5px;
        transition: color 0.3s;
    }

        .eye-btn:hover:not(:disabled) {
            color: #667eea;
        }

        .eye-btn:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }

    .role-group {
        display: block;
    }

    .role-options {
        display: flex;
        gap: 1rem;
        margin-top: 0.5rem;
    }

    .role-option {
        flex: 1;
        cursor: pointer;
        margin: 0;
    }

        .role-option input[type="radio"] {
            display: none;
        }

    .role-card {
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        padding: 1.25rem 0.75rem;
        text-align: center;
        transition: all 0.3s;
        background: white;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }

        .role-card i {
            font-size: 2rem;
            color: #667eea;
            margin-bottom: 0.5rem;
        }

        .role-card span {
            font-size: 0.9rem;
            font-weight: 500;
            color: #333;
        }

    .role-option input[type="radio"]:checked + .role-card {
        border-color: #667eea;
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
    }

    .role-option:hover .role-card {
        border-color: #667eea;
        transform: translateY(-2px);
    }

    .btn-register {
        height: 45px;
        font-size: 1rem;
        font-weight: 600;
        border-radius: 8px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        transition: all 0.3s;
    }

        .btn-register:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-register:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

    .divider {
        text-align: center;
        margin: 1.5rem 0;
        position: relative;
    }

        .divider::before,
        .divider::after {
            content: "";
            position: absolute;
            top: 50%;
            width: 45%;
            height: 1px;
            background: #ddd;
        }

        .divider::before {
            left: 0;
        }

        .divider::after {
            right: 0;
        }

        .divider span {
            background: white;
            padding: 0 1rem;
            color: #999;
            font-size: 0.9rem;
        }

    .text-danger {
        color: #dc3545;
        font-size: 0.875rem;
        margin-top: 0.25rem;
        display: block;
    }

    .login-link {
        color: #666;
        font-size: 0.95rem;
    }

        .login-link a {
            text-decoration: none;
            transition: color 0.3s;
        }

            .login-link a:hover {
                color: #764ba2 !important;
                text-decoration: underline;
            }

    /* Responsive */
    @@media (max-width: 992px) {
        .register-wrapper {
            flex-direction: column;
        }

        .register-left {
            padding: 2rem 1rem;
        }

        .register-gif {
            width: 250px;
        }

        .register-title {
            font-size: 2rem;
        }

        .register-subtitle {
            font-size: 1rem;
        }

        .register-form-container {
            padding: 2rem 1.5rem;
        }

        .role-options {
            flex-direction: column;
        }

        .role-card {
            flex-direction: row;
            justify-content: flex-start;
            padding: 1rem;
        }

            .role-card i {
                margin-bottom: 0;
                margin-right: 0.75rem;
                font-size: 1.5rem;
            }
    }

    @@media (max-width: 576px) {
        .register-form-container {
            padding: 1.5rem 1rem;
        }

        .form-title {
            font-size: 1.5rem;
        }

        .register-title {
            font-size: 1.75rem;
        }
    }
</style>

@code {
    private RegisterVm registerModel = new();
    private string passwordType = "password";
    private bool isLoading = false;
    private Dictionary<string, string[]> errors = new();

    private void TogglePassword()
    {
        passwordType = passwordType == "password" ? "text" : "password";
    }

    private string GetInputClass(string fieldName)
    {
        return HasError(fieldName) ? "form-control is-invalid" : "form-control";
    }

    private async Task HandleRegister()
    {
        isLoading = true;
        errors.Clear();

        var result = await AuthService.RegisterAsync(
            registerModel.Username,
            registerModel.FullName,
            registerModel.Email,
            registerModel.Password,
            registerModel.Role
        );

        var (success, msg, fieldErrors) = result;

        if (success)
        {
            await JSRuntime.InvokeVoidAsync("Swal.fire", "Thành công!", msg, "success");
            await Task.Delay(800);
            Nav.NavigateTo("/login");
        }
        else
        {
            if (fieldErrors != null && fieldErrors.Count > 0)
                errors = fieldErrors;
            else
                await JSRuntime.InvokeVoidAsync("Swal.fire", "Lỗi!", msg, "error");
        }

        isLoading = false;
    }

    private bool HasError(string field) => errors.ContainsKey(field);

    private RenderFragment ValidationError(string field) => builder =>
    {
        if (errors.TryGetValue(field, out var msgs) && msgs != null && msgs.Length > 0)
        {
            builder.OpenElement(0, "div");
            builder.AddAttribute(1, "class", "text-danger small mt-1");
            builder.AddContent(2, msgs[0]);
            builder.CloseElement();
        }
    };

    private class RegisterVm
    {
        public string Username { get; set; } = "";
        public string FullName { get; set; } = "";
        public string Email { get; set; } = "";
        public string Password { get; set; } = "";
        public UserRole Role { get; set; } = UserRole.HocSinh;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JSRuntime.InvokeVoidAsync("loadGoogleSignIn");
        }
    }
}
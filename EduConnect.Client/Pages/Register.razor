@page "/register"
@using System.Net.Http.Json
@inject HttpClient Http
@inject IJSRuntime JSRuntime


<div class="register-wrapper">
    <div class="register-left">
        <img src="images/reg.gif" alt="Đăng ký" />
        <h2>ĐĂNG KÝ NGAY</h2>
        <p>Học thử miễn phí cùng EduConnect</p>
    </div>

    <div class="register-right">
        <h3>Đăng ký tài khoản</h3>

        <EditForm Model="@registerModel" OnValidSubmit="@HandleRegister">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <div class="form-group">
                <InputText @bind-Value="registerModel.FullName" placeholder="Họ và tên" class="form-control" />
            </div>

            <div class="form-group">
                <InputText @bind-Value="registerModel.Username" placeholder="Tên đăng nhập" class="form-control" />
            </div>

            <div class="form-group">
                <InputText @bind-Value="registerModel.Email" placeholder="Email" class="form-control" />
            </div>

            <div class="form-group password-box">
                <InputText @bind-Value="registerModel.Password"
                           type="@passwordType"
                           placeholder="Mật khẩu"
                           class="form-control" />
                <button type="button" class="eye-btn" @onclick="TogglePassword">
                    <i class="fa @(passwordType == "password" ? "fa-eye" : "fa-eye-slash")"></i>
                </button>
            </div>

            <button class="btn btn-primary w-100" type="submit">Đăng ký</button>

            <div class="text-center mt-3">Hoặc</div>

            <div class="btn btn-google w-100 text-center" id="googleSignInContainer">
                <i class="fa fa-google"></i> Đăng nhập bằng Google
            </div>


            <div class="mt-3 text-center">
                Đã có tài khoản? <a href="/login">Đăng nhập</a>
            </div>
        </EditForm>

        @if (!string.IsNullOrEmpty(message))
        {
            <div class="alert mt-3 @(isSuccess ? "alert-success" : "alert-danger")">
                @message
            </div>
        }
    </div>
</div>

@code {
    private RegisterRequest registerModel = new();
    private string message = "";
    private bool isSuccess = false;
    private string passwordType = "password";

    private void TogglePassword()
    {
        passwordType = passwordType == "password" ? "text" : "password";
    }

    private async Task HandleRegister()
    {
        try
        {
            var res = await Http.PostAsJsonAsync("auth/register", registerModel);

            if (res.IsSuccessStatusCode)
            {
                isSuccess = true;
                message = "🎉 Đăng ký thành công!";
            }
            else
            {
                isSuccess = false;

                // Đọc phản hồi từ API, ưu tiên message JSON
                var apiError = await res.Content.ReadFromJsonAsync<ApiError>();
                message = apiError?.Message ?? "Đăng ký thất bại!";
            }
        }
        catch (Exception ex)
        {
            isSuccess = false;
            message = $"⚠️ Lỗi kết nối: {ex.Message}";
        }
    }
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JSRuntime.InvokeVoidAsync("loadGoogleSignIn");
        }
    }


    public class RegisterRequest
    {
        public string Username { get; set; } = "";
        public string FullName { get; set; } = "";
        public string Email { get; set; } = "";
        public string Password { get; set; } = "";
    }

    public class ApiError
    {
        public string? Message { get; set; }
    }
}

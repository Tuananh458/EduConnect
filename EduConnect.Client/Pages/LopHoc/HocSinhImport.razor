@using EduConnect.Shared.DTOs.HocSinh
@inject HttpClient Http
@inject IJSRuntime JS

<div>
    @if (Preview == null)
    {
        <!-- ================== BƯỚC 1: CHỌN FILE IMPORT =================== -->
        <div class="card p-3 shadow-sm">
            <h5 class="fw-bold text-primary mb-3">📥 Import danh sách học sinh</h5>

            <InputFile OnChange="OnFileSelected" />
            <div class="mt-3">
                <label class="form-label">Tiền tố tên đăng nhập</label>
                <input class="form-control" @bind="Prefix" placeholder="vd: 6a1_" />
                <small class="text-muted">Không chứa dấu "_"</small>
            </div>
            <div class="mt-3">
                <label class="form-label">Mật khẩu mặc định</label>
                <input class="form-control" @bind="DefaultPassword" placeholder="ít nhất 6 ký tự" />
            </div>

            <div class="d-flex gap-2 mt-3">
                <button class="btn btn-primary" @onclick="PreviewImport"><i class="fas fa-eye"></i> Duyệt danh sách</button>
                <button class="btn btn-outline-secondary" @onclick="DownloadTemplate"><i class="fas fa-file-excel"></i> Tải file mẫu</button>
                <button class="btn btn-secondary" @onclick="OnCancel">Hủy</button>
            </div>

            @if (!string.IsNullOrEmpty(Message))
            {
                <div class="alert alert-info mt-3">@Message</div>
            }
        </div>
    }
    else
    {
        <!-- ================== BƯỚC 2: HIỂN THỊ DANH SÁCH PREVIEW =================== -->
        <div class="card p-3 shadow-sm">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="fw-bold text-primary m-0">🧾 Danh sách học sinh (Preview)</h5>
                <button class="btn btn-outline-info btn-sm" @onclick="AutoFix">
                    <i class="fas fa-sync-alt"></i> Tự động sửa tài khoản chưa hợp lệ
                </button>
            </div>

            <div class="table-responsive">
                <table class="table table-bordered align-middle text-center">
                    <thead class="table-light">
                        <tr>
                            <th>STT</th>
                            <th>Họ và tên</th>
                            <th>Tên đăng nhập</th>
                            <th>Mật khẩu</th>
                            <th>Mã định danh</th>
                            <th>Ngày sinh</th>
                            <th>Email</th>
                            <th>Trạng thái</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var (it, idx) in Preview.Items.Select((v, i) => (v, i)))
                        {
                            <tr class="@(it.HopLe ? "" : "table-danger")">
                                <td>@(idx + 1)</td>
                                <td><input class="form-control" @bind="it.HoVaTen" /></td>
                                <td><input class="form-control" @bind="it.TenDangNhap" /></td>
                                <td><input class="form-control" @bind="it.MatKhau" /></td>
                                <td><input class="form-control" @bind="it.MaDinhDanh" /></td>
                                <td>
                                    <input class="form-control" value="@(it.NgaySinh?.ToString("yyyy-MM-dd"))"
                                           @onchange="e => it.NgaySinh = DateTime.TryParse(e.Value?.ToString(), out var d) ? d : null" />
                                </td>
                                <td><input class="form-control" @bind="it.Email" /></td>
                                <td>@(it.HopLe ? "✅ Hợp lệ" : $"❌ {it.Loi}")</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <div class="d-flex gap-2 mt-3">
                <button class="btn btn-success" @onclick="@(()=>ConfirmImport("createOnly"))">Xác nhận tạo tài khoản</button>
                <button class="btn btn-warning text-white" @onclick="@(()=>ConfirmImport("addToClass"))">Thêm tất cả học sinh vào lớp</button>
                <button class="btn btn-info text-white" @onclick="@(()=>ConfirmImport("transferToClass"))">Chuyển tất cả học sinh vào lớp</button>
                <button class="btn btn-secondary" @onclick="ResetView">Hủy</button>
            </div>


        </div>
    }
</div>

@code {
    [Parameter] public int MaLopHoc { get; set; }
    [Parameter] public EventCallback OnCompleted { get; set; }

    private IBrowserFile? selectedFile;
    private string? Prefix;
    private string? DefaultPassword;
    private string? Message;
    private ImportPreviewResponse? Preview;

    private void OnFileSelected(InputFileChangeEventArgs e) => selectedFile = e.File;

    private async Task DownloadTemplate()
    {
        var bytes = await Http.GetByteArrayAsync("api/hocsinh/template");
        var base64 = Convert.ToBase64String(bytes);
        await JS.InvokeVoidAsync("downloadFileFromStream", "MauImportHocSinh.xlsx", base64);
    }

    private async Task PreviewImport()
    {
        if (selectedFile == null)
        {
            await JS.InvokeVoidAsync("alert", "Vui lòng chọn file Excel hoặc CSV!");
            return;
        }
        using var content = new MultipartFormDataContent();
        var fileContent = new StreamContent(selectedFile.OpenReadStream(10_000_000));
        fileContent.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue(selectedFile.ContentType);
        content.Add(fileContent, "file", selectedFile.Name);

        var url = $"api/hocsinh/import/preview?maLopHoc={MaLopHoc}&prefix={Prefix}&defaultPassword={DefaultPassword}";
        var res = await Http.PostAsync(url, content);
        if (res.IsSuccessStatusCode)
        {
            Preview = await res.Content.ReadFromJsonAsync<ImportPreviewResponse>();
            Message = null;
        }
        else
        {
            Message = await res.Content.ReadAsStringAsync();
        }
    }

    private void AutoFix()
    {
        if (Preview?.Items == null) return;
        var pf = string.IsNullOrWhiteSpace(Preview.Prefix) ? "hs_" : Preview.Prefix!;
        foreach (var it in Preview.Items)
        {
            if (!string.IsNullOrEmpty(it.TenDangNhap) && char.IsDigit(it.TenDangNhap[0]))
                it.TenDangNhap = pf + it.TenDangNhap;
            if (string.IsNullOrEmpty(it.MatKhau))
                it.MatKhau = it.TenDangNhap;
            if (string.IsNullOrEmpty(it.MaDinhDanh))
                it.MaDinhDanh = "HS" + DateTime.UtcNow.Ticks.ToString().Substring(8);

            it.HopLe = true;
            it.Loi = null;
        }
    }

    private async Task ConfirmImport(string action)
    {
        if (Preview == null) return;
        var req = new ImportConfirmRequest
            {
                MaLopHoc = MaLopHoc,
                Items = Preview.Items,
                Action = action
            };

        var res = await Http.PostAsJsonAsync("api/hocsinh/import/confirm", req);
        if (res.IsSuccessStatusCode)
        {
            var data = await res.Content.ReadFromJsonAsync<ImportConfirmResult>();
            await JS.InvokeVoidAsync("alert", $"✅ Import thành công: {data?.Created} tạo mới, {data?.AddedToClass} thêm vào lớp, {data?.Transferred} chuyển lớp.");
            await OnCompleted.InvokeAsync();
            ResetView();
        }
        else
        {
            await JS.InvokeVoidAsync("alert", "❌ Lỗi import: " + await res.Content.ReadAsStringAsync());
        }
    }

    private void ResetView() => Preview = null;
    private void OnCancel() => OnCompleted.InvokeAsync();
}
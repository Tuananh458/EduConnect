@page "/hoclieu/editor/{HocLieuId:int}"
@using EduConnect.Client.Services
@using EduConnect.Shared.DTOs.HocLieu
@using EduConnect.Client.Pages.HocLieu.Components
@inject HocLieuService HocLieuService
@inject CauHoiHocLieuService CauHoiService
@inject IJSRuntime JS

<div class="container-fluid p-3">
    <!-- Breadcrumb -->
    <div class="mb-2">
        <a href="/hoclieu" class="text-primary text-decoration-none fw-semibold">Học liệu</a> >
        <span class="fw-semibold">@hocLieu?.TenHocLieu</span>
    </div>

    <h4 class="fw-bold text-uppercase mb-3">@hocLieu?.TenHocLieu</h4>

    <!-- Toolbar -->
    <div class="d-flex align-items-center gap-2 mb-3">
        <button class="btn btn-warning"><i class="fas fa-random me-1"></i> Trộn đề</button>
        <button class="btn btn-outline-secondary"><i class="fas fa-cog me-1"></i> Thiết lập</button>
        <button class="btn btn-outline-secondary"><i class="fas fa-tasks me-1"></i> DS bài làm</button>
        <button class="btn btn-outline-secondary"><i class="fas fa-chart-line me-1"></i> Thống kê</button>
        <button class="btn btn-outline-secondary"><i class="fas fa-edit me-1"></i> Lịch sử chỉnh sửa</button>
        <button class="btn btn-primary ms-auto"><i class="fas fa-plus me-1"></i> Giao bài</button>
    </div>

    <!-- Danh sách câu hỏi -->
    <div class="card shadow-sm">
        <div class="card-header bg-light fw-semibold">
            <i class="fas fa-layer-group me-1"></i> Tạo nội dung học liệu
        </div>

        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="fw-semibold mb-0">Câu hỏi thuộc học liệu: [@hocLieu?.TenHocLieu]</h6>
                <button class="btn btn-primary" @onclick="ShowAddQuestionModal">
                    <i class="fas fa-plus"></i> Tạo câu hỏi
                </button>
            </div>

            @if (questions == null)
            {
                <div class="text-muted text-center p-3">Đang tải dữ liệu...</div>
            }
            else if (!questions.Any())
            {
                <div class="alert alert-info text-center m-0 p-3">Chưa có câu hỏi nào</div>
            }
            else
            {
                <div class="list-group">
                    @foreach (var q in questions)
                    {
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <span class="fw-semibold">@((MarkupString)q.NoiDung)</span>
                                <div class="text-muted small">Độ khó: @q.DoKho</div>
                            </div>
                            <div class="d-flex gap-2">
                                <button class="btn btn-outline-secondary btn-sm" @onclick="() => PreviewExistingQuestion(q)">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-outline-danger btn-sm" @onclick="() => DeleteQuestion(q.Id)">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    }
                </div>
            }
        </div>
    </div>

    <!-- MODAL: Tạo câu hỏi -->
    @if (showAdd)
    {
        <div class="modal fade show d-block" style="background:rgba(0,0,0,.45); z-index:1050;">
            <div class="modal-dialog modal-xl modal-dialog-centered">
                <div class="modal-content border-0 shadow-lg rounded-3 overflow-hidden">
                    <div class="modal-header bg-white py-3 px-4 border-bottom">
                        <h5 class="fw-semibold mb-0">Tạo câu hỏi mới</h5>
                        <div class="ms-auto d-flex align-items-center gap-2">
                            <a href="https://olm.vn/chu-de/tao-16-dang-cau-hoi-tuong-tac-538356"
                               target="_blank"
                               class="btn btn-link text-danger text-decoration-none">Hướng dẫn</a>
                            <button class="btn btn-outline-warning" @onclick="PreviewQuestion">
                                <i class="fas fa-eye me-1"></i> Xem thử
                            </button>
                            <button class="btn btn-primary" @onclick="SaveQuestion">
                                <i class="fas fa-save me-1"></i> Lưu
                            </button>
                            <button type="button" class="btn-close" @onclick="CloseAddModal"></button>
                        </div>
                    </div>

                    <div class="modal-body p-0 d-flex" style="min-height: 550px;">
                        <!-- Sidebar -->
                        <div class="border-end bg-light p-3" style="width: 230px;">
                            <div class="list-group list-group-flush small">
                                <button class="list-group-item list-group-item-action active text-start">
                                    <i class="fas fa-list me-2"></i> Trắc nghiệm
                                </button>
                                <button class="list-group-item list-group-item-action text-start">Đúng/Sai</button>
                                <button class="list-group-item list-group-item-action text-start">Điền khuyết</button>
                                <button class="list-group-item list-group-item-action text-start">Ghép cặp</button>
                                <button class="list-group-item list-group-item-action text-start">Tự luận</button>
                            </div>
                        </div>

                        <!-- Nội dung chính -->
                        <div class="flex-grow-1 bg-white p-4">
                            <div class="d-flex align-items-center mb-3">
                                <InputText class="form-control form-control-lg fw-semibold"
                                           @bind-Value="createModel.TieuDe"
                                           placeholder="Nhập tiêu đề câu hỏi" />
                                <div class="ms-3">
                                    <div class="btn-group">
                                        @foreach (var level in mucDos)
                                        {
                                            <button class="btn @(createModel.DoKho == level ? "btn-primary" : "btn-outline-primary")"
                                                    @onclick="() => createModel.DoKho = level">
                                                @level
                                            </button>
                                        }
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label fw-semibold">Nội dung câu hỏi</label>
                                <textarea id="editor1" class="form-control"></textarea>
                            </div>

                            <div class="mt-4">
                                <h6 class="fw-semibold mb-2">Đáp án</h6>
                                <CauHoiAnswerList @ref="answerList"
                                                  AllowMultiple="@multiCorrect"
                                                  Answers="@answers" />
                            </div>

                            <div class="d-flex justify-content-end gap-2 mt-4 border-top pt-3">
                                <button class="btn btn-outline-warning" @onclick="PreviewQuestion">Xem thử</button>
                                <button class="btn btn-primary" @onclick="SaveQuestion">Lưu câu hỏi</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- MODAL: Xem thử -->
    @if (showPreview)
    {
        <CauHoiPreview NoiDung="@previewContent"
                       Answers="@answers"
                       OnClose="() => showPreview = false" />
    }
</div>

@code {
    [Parameter] public int HocLieuId { get; set; }

    private HocLieuDto? hocLieu;
    private List<CauHoiHocLieuDto>? questions;
    private CreateCauHoiHocLieuRequest createModel = new();
    private List<CauHoiAnswerList.AnswerOption> answers = new();
    private CauHoiAnswerList? answerList;

    private readonly string[] mucDos = { "Nhận biết", "Thông hiểu", "Vận dụng", "Vận dụng cao" };

    private bool showAdd, showPreview;
    private bool multiCorrect = false;
    private string? previewContent;

    protected override async Task OnInitializedAsync()
    {
        hocLieu = await HocLieuService.GetByIdAsync(HocLieuId);
        questions = await CauHoiService.GetByHocLieuAsync(HocLieuId);
    }

    // ==============================
    // 1️⃣ Hiển thị modal tạo câu hỏi
    // ==============================
    private async Task ShowAddQuestionModal()
    {
        createModel = new()
            {
                HocLieuId = HocLieuId,
                LoaiCauHoi = "TracNghiem",
                DoKho = "Nhận biết",
                Diem = 1
            };

        answers = new()
        {
            new() { Content = "", IsCorrect = false },
            new() { Content = "", IsCorrect = false },
            new() { Content = "", IsCorrect = false },
            new() { Content = "", IsCorrect = false }
        };

        showAdd = true;
        await Task.Delay(200);
        await JS.InvokeVoidAsync("tinyHelper.initTiny", "editor1");
    }

    private async Task CloseAddModal()
    {
        await JS.InvokeVoidAsync("tinyHelper.destroyTiny", "editor1");
        showAdd = false;
    }

    // ==============================
    // 2️⃣ Xem thử câu hỏi hiện tại
    // ==============================
    private async Task PreviewQuestion()
    {
        previewContent = await JS.InvokeAsync<string>("tinyHelper.getContent", "editor1");
        showPreview = true;
    }

    private void PreviewExistingQuestion(CauHoiHocLieuDto q)
    {
        previewContent = q.NoiDung;
        answers = new()
        {
            new() { Content = q.DapAnA ?? "", IsCorrect = q.DapAnDung == "A" },
            new() { Content = q.DapAnB ?? "", IsCorrect = q.DapAnDung == "B" },
            new() { Content = q.DapAnC ?? "", IsCorrect = q.DapAnDung == "C" },
            new() { Content = q.DapAnD ?? "", IsCorrect = q.DapAnDung == "D" }
        };
        showPreview = true;
    }

    // ==============================
    // 3️⃣ Lưu câu hỏi mới
    // ==============================
    private async Task SaveQuestion()
    {
        createModel.NoiDung = await JS.InvokeAsync<string>("tinyHelper.getContent", "editor1");

        createModel.DapAnA = answers.ElementAtOrDefault(0)?.Content ?? "";
        createModel.DapAnB = answers.ElementAtOrDefault(1)?.Content ?? "";
        createModel.DapAnC = answers.ElementAtOrDefault(2)?.Content ?? "";
        createModel.DapAnD = answers.ElementAtOrDefault(3)?.Content ?? "";

        createModel.DapAnDung = answers.FindIndex(a => a.IsCorrect) switch
        {
            0 => "A",
            1 => "B",
            2 => "C",
            3 => "D",
            _ => ""
        };

        await CauHoiService.CreateAsync(createModel);
        questions = await CauHoiService.GetByHocLieuAsync(HocLieuId);

        await CloseAddModal();
        StateHasChanged();
    }

    // ==============================
    // 4️⃣ Xóa câu hỏi
    // ==============================
    private async Task DeleteQuestion(int id)
    {
        if (await JS.InvokeAsync<bool>("confirm", "Xóa câu hỏi này?"))
        {
            await CauHoiService.DeleteAsync(id);
            questions?.RemoveAll(x => x.Id == id);
        }
    }
}

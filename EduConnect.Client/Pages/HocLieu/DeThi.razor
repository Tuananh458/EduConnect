@page "/bailamhoclieu/dethi/{hocLieuId:int}"
@inject HttpClient Http
@inject IJSRuntime JS
@using System.Net.Http.Json

<style>
    .exam-container {
        max-width: 900px;
        margin: 20px auto;
        font-family: 'Segoe UI', sans-serif;
    }

    .exam-header {
        background: #ffffff;
        border-radius: 10px;
        padding: 15px 25px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
    }

    .exam-title h3 {
        font-weight: 700;
        color: #0057b7;
        margin-bottom: 4px;
    }

    .exam-actions .btn {
        border-radius: 8px;
        padding: 8px 14px;
        font-weight: 500;
    }

    .exam-body {
        margin-top: 25px;
    }

    .question-card {
        background: #fff;
        border-radius: 12px;
        padding: 18px 22px;
        margin-bottom: 25px;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
        transition: transform 0.2s, box-shadow 0.2s;
    }

        .question-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
        }

        .question-card .fw-bold {
            color: #333;
        }

    .answers label {
        display: block;
        padding: 6px 10px;
        border-radius: 8px;
        cursor: pointer;
        transition: background-color 0.2s, color 0.2s;
    }

        .answers label:hover {
            background: #f4f8ff;
        }

    .answers input[type="radio"] {
        accent-color: #007bff;
    }

    .timer {
        background: #fff1f1;
        padding: 6px 16px;
        border-radius: 8px;
        font-weight: 600;
        font-size: 18px;
        color: #d32f2f;
        box-shadow: inset 0 0 4px rgba(255, 0, 0, 0.1);
    }

    textarea.form-control {
        margin-top: 8px;
        border-radius: 8px;
        resize: none;
    }

    .btn-success {
        background-color: #28a745;
        border: none;
    }

        .btn-success:hover {
            background-color: #218838;
        }

    .btn-outline-primary:hover {
        background-color: #007bff;
        color: white;
    }
</style>

<div class="exam-container">
    @if (isLoading)
    {
        <div class="text-center mt-5">
            <div class="spinner-border text-primary"></div>
            <p class="mt-3">Đang tải đề thi...</p>
        </div>
    }
    else if (deThi == null)
    {
        <div class="alert alert-warning text-center mt-5">Không tìm thấy đề thi.</div>
    }
    else
    {
        <div class="exam-header">
            <div class="exam-title">
                <h3>@deThi.TenHocLieu</h3>
                <small class="text-secondary">Mã học liệu: @deThi.HocLieuId</small>
            </div>

            <div class="exam-actions">
                <span class="timer me-3">@($"{remaining.Minutes:D2}:{remaining.Seconds:D2}")</span>
                <button class="btn btn-outline-primary me-2" @onclick="SaveDraft">💾 Lưu tạm</button>
                <button class="btn btn-success" @onclick="ConfirmNopBai">📤 Nộp bài</button>
            </div>
        </div>

        <div class="exam-body">
            @foreach (var (cau, index) in deThi.CauHoi.Select((value, i) => (value, i + 1)))
            {
                <div class="question-card">
                    <div class="fw-bold mb-2">Câu @index (@cau.Diem.ToString("0.#") đ):</div>
                    <div class="question-content mb-2" style="line-height:1.6;">
                        @((MarkupString)cau.NoiDung)
                    </div>

                    @if (cau.LoaiCauHoi == "TracNghiem")
                    {
                        <div class="answers ms-3">
                            @foreach (var luaChon in new[] { "A", "B", "C", "D" })
                            {
                                var noiDung = cau.GetLuaChon(luaChon);
                                if (!string.IsNullOrEmpty(noiDung))
                                {
                                    <label>
                                        <input type="radio"
                                               name="@($"cau{cau.Id}")"
                                               value="@luaChon"
                                               @onchange="(e) => ChonDapAn(cau.Id, e.Value?.ToString())"
                                               checked="@((dapAnHocSinh.TryGetValue(cau.Id, out var da) && da == luaChon))" />
                                        <span class="ms-2">@((MarkupString)noiDung)</span>
                                    </label>
                                }
                            }
                        </div>
                    }
                    else
                    {
                        <textarea class="form-control" rows="3" placeholder="Nhập câu trả lời..."
                                  @bind="@dapAnTuLuan[cau.Id]"></textarea>
                    }
                </div>
            }
        </div>
    }
</div>

@code {
    [Parameter] public int hocLieuId { get; set; }

    private DeThiDto? deThi;
    private bool isLoading = true;
    private Dictionary<int, string> dapAnHocSinh = new();
    private Dictionary<int, string> dapAnTuLuan = new();
    private TimeSpan remaining = TimeSpan.FromMinutes(30);
    private System.Timers.Timer? timer;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            deThi = await Http.GetFromJsonAsync<DeThiDto>($"api/BaiLamHocLieu/dethi/{hocLieuId}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Lỗi tải đề thi: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StartTimer();
        }
    }

    private void StartTimer()
    {
        timer = new System.Timers.Timer(1000);
        timer.Elapsed += (s, e) =>
        {
            if (remaining.TotalSeconds <= 0)
            {
                timer.Stop();
                InvokeAsync(NopBai);
            }
            else
            {
                remaining = remaining.Subtract(TimeSpan.FromSeconds(1));
                InvokeAsync(StateHasChanged);
            }
        };
        timer.Start();
    }

    private void ChonDapAn(int cauHoiId, string? dapAn)
    {
        if (!string.IsNullOrEmpty(dapAn))
            dapAnHocSinh[cauHoiId] = dapAn;
    }

    private async Task SaveDraft()
    {
        await JS.InvokeVoidAsync("alert", "💾 Đã lưu tạm tiến trình làm bài!");
    }

    private async Task ConfirmNopBai()
    {
        var confirm = await JS.InvokeAsync<bool>("confirm", "📤 Bạn có chắc chắn muốn nộp bài không?");
        if (confirm)
            await NopBai();
    }

    private async Task NopBai()
    {
        var cauTraLoi = dapAnHocSinh.Select(x => new CauTraLoiDto { CauHoiId = x.Key, DapAn = x.Value }).ToList();

        var request = new NopBaiRequest
            {
                HocLieuId = hocLieuId,
                HocSinhId = 1, // TODO: lấy từ session đăng nhập
                CauTraLoi = cauTraLoi
            };

        var res = await Http.PostAsJsonAsync("api/BaiLamHocLieu/nop", request);
        if (res.IsSuccessStatusCode)
            await JS.InvokeVoidAsync("alert", "✅ Nộp bài thành công!");
        else
            await JS.InvokeVoidAsync("alert", "❌ Nộp bài thất bại!");
    }

    public class DeThiDto
    {
        public int HocLieuId { get; set; }
        public string TenHocLieu { get; set; } = "";
        public List<CauHoiDto> CauHoi { get; set; } = new();
    }

    public class CauHoiDto
    {
        public int Id { get; set; }
        public string NoiDung { get; set; } = "";
        public string LoaiCauHoi { get; set; } = "";
        public double Diem { get; set; }
        public string? DapAnA { get; set; }
        public string? DapAnB { get; set; }
        public string? DapAnC { get; set; }
        public string? DapAnD { get; set; }

        public string? GetLuaChon(string luaChon) => luaChon switch
        {
            "A" => DapAnA,
            "B" => DapAnB,
            "C" => DapAnC,
            "D" => DapAnD,
            _ => null
        };
    }

    public class NopBaiRequest
    {
        public int HocLieuId { get; set; }
        public int HocSinhId { get; set; }
        public List<CauTraLoiDto> CauTraLoi { get; set; } = new();
    }

    public class CauTraLoiDto
    {
        public int CauHoiId { get; set; }
        public string? DapAn { get; set; }
    }
}

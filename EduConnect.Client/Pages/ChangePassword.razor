@page "/change-password"
@attribute [Authorize]
@layout AuthLayout
@using System.Net.Http.Json
@using Microsoft.AspNetCore.Authorization
@inject HttpClient Http
@inject NavigationManager Nav
@inject Blazored.LocalStorage.ILocalStorageService LocalStorage

<div class="change-wrapper">
    <div class="change-box">
        <img src="images/logo.png" alt="EduConnect" width="90" class="mx-auto d-block mb-3" />

        <h3 class="text-center mb-3">ĐỔI MẬT KHẨU</h3>
        <p class="text-center text-muted mb-4">
            Vui lòng nhập mật khẩu cũ và đặt mật khẩu mới của bạn.
        </p>

        <EditForm Model="@model" OnValidSubmit="@HandleChangePassword">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <div class="mb-3">
                <label class="form-label">Mật khẩu cũ</label>
                <InputText @bind-Value="model.OldPassword" class="form-control" type="password" placeholder="Nhập mật khẩu cũ" />
            </div>

            <div class="mb-3">
                <label class="form-label">Mật khẩu mới</label>
                <InputText @bind-Value="model.NewPassword" class="form-control" type="password" placeholder="Nhập mật khẩu mới" />
            </div>

            <div class="mb-3">
                <label class="form-label">Nhập lại mật khẩu mới</label>
                <InputText @bind-Value="confirmPassword" class="form-control" type="password" placeholder="Xác nhận mật khẩu mới" />
            </div>

            <button class="btn btn-primary w-100" type="submit" disabled="@isLoading">
                @(isLoading ? "Đang xử lý..." : "Đổi mật khẩu")
            </button>

            <div class="text-center mt-3">
                <a href="/profile">← Quay lại hồ sơ</a>
            </div>

            @if (!string.IsNullOrEmpty(message))
            {
                <div class="alert mt-3 @(isSuccess ? "alert-success" : "alert-danger")">@message</div>
            }
        </EditForm>
    </div>
</div>

@code {
    private ChangePasswordRequest model = new();
    private string confirmPassword = "";
    private string message = "";
    private bool isSuccess = false;
    private bool isLoading = false;

    private async Task HandleChangePassword()
    {
        if (model.NewPassword != confirmPassword)
        {
            message = "❌ Mật khẩu mới không trùng khớp.";
            isSuccess = false;
            return;
        }

        try
        {
            isLoading = true;
            message = "";

            // 🟢 Lấy token từ localStorage
            var token = await LocalStorage.GetItemAsStringAsync("access_token");
            if (string.IsNullOrEmpty(token))
            {
                message = "⚠️ Phiên đăng nhập đã hết hạn. Vui lòng đăng nhập lại.";
                isSuccess = false;
                Nav.NavigateTo("/login", true);
                return;
            }

            // 🟢 Gửi request có Bearer Token
            var req = new HttpRequestMessage(HttpMethod.Post, "api/auth/change-password");
            req.Headers.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token.Trim('"'));
            req.Content = JsonContent.Create(model);

            var res = await Http.SendAsync(req);
            var json = await res.Content.ReadAsStringAsync();

            Console.WriteLine($"ChangePassword Response: {json}");

            // 🟢 Giải mã đúng format API backend trả về
            var api = System.Text.Json.JsonSerializer.Deserialize<ApiEnvelope>(
                json,
                new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true }
            );

            if (res.IsSuccessStatusCode && api?.Status == "success")
            {
                isSuccess = true;
                message = $"✅ {api.Message ?? "Đổi mật khẩu thành công!"}";
                model = new();
                confirmPassword = "";
            }
            else
            {
                isSuccess = false;
                message = $"❌ {api?.Message ?? "Đổi mật khẩu thất bại"}";
            }
        }
        catch (Exception ex)
        {
            message = $"⚠️ Lỗi kết nối: {ex.Message}";
            isSuccess = false;
        }
        finally
        {
            isLoading = false;
        }
    }

    // 🧩 Các class model
    public class ChangePasswordRequest
    {
        public string OldPassword { get; set; } = "";
        public string NewPassword { get; set; } = "";
    }

    public class ApiEnvelope
    {
        public string? Status { get; set; }
        public string? Message { get; set; }
        public object? Data { get; set; }
        public object? Errors { get; set; }
    }
}
